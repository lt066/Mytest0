package com.example.activity;

import android.annotation.SuppressLint;
import android.content.Context;
import android.os.Bundle;
import android.util.Log;



import com.amap.api.location.AMapLocation;
import com.amap.api.location.AMapLocationClient;
import com.amap.api.location.AMapLocationClientOption;
import com.amap.api.location.AMapLocationClientOption.AMapLocationMode;
import com.amap.api.location.AMapLocationListener;
import com.amap.api.maps2d.AMap;
import com.amap.api.maps2d.LocationSource;
import com.amap.api.maps2d.MapView;
import com.example.mytest0.BaseActivity;
import com.example.mytest0.R;

public class GaodeMap_activity extends BaseActivity implements LocationSource{
	MapView mMapView = null;
	private AMap aMap;
	//声明AMapLocationClient类对象
	public AMapLocationClient mLocationClient = null;
	//声明定位回调监听器
	public AMapLocationListener mLocationListener = new MyMapLocationListener();
	//声明mLocationOption对象
	public AMapLocationClientOption mLocationOption = null;
	

	@Override
	@SuppressLint("NewApi")
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		setContentView(R.layout.gaode_map);
		//初始化定位
		mLocationClient = new AMapLocationClient(getApplicationContext());
		//设置定位回调监听
		mLocationClient.setLocationListener(mLocationListener);
		  //获取地图控件引用
	    mMapView = (MapView) findViewById(R.id.map);
	    //在activity执行onCreate时执行mMapView.onCreate(savedInstanceState)，实现地图生命周期管理
	    mMapView.onCreate(savedInstanceState);
	    aMap=mMapView.getMap();
	    aMap.setLocationSource(this);// 设置定位监听
	    aMap.getUiSettings().setMyLocationButtonEnabled(true);// 设置默认定位按钮是否显示
	    aMap.setMyLocationEnabled(true);// 设置为true表示显示定位层并可触发定位，false表示隐藏定位层并不可触发定位，默认是false
	    // 设置3D定位的类型为定位模式，参见类AMap。
//	    aMap.setMyLocationType(AMap.LOCATION_TYPE_LOCATE);
	  //初始化定位参数
	    mLocationOption = new AMapLocationClientOption();
	    //设置定位模式为高精度模式，Battery_Saving为低功耗模式，Device_Sensors是仅设备模式
	    mLocationOption.setLocationMode(AMapLocationMode.Hight_Accuracy);
	    //设置是否返回地址信息（默认返回地址信息）
	    mLocationOption.setNeedAddress(true);
	    //设置是否只定位一次,默认为false
	    mLocationOption.setOnceLocation(false);
	    //设置是否强制刷新WIFI，默认为强制刷新
	    mLocationOption.setWifiActiveScan(true);
	    //设置是否允许模拟位置,默认为false，不允许模拟位置
	    mLocationOption.setMockEnable(false);
	    //设置定位间隔,单位毫秒,默认为2000ms
	    mLocationOption.setInterval(2000);
	    //给定位客户端对象设置定位参数
	    mLocationClient.setLocationOption(mLocationOption);
	    //启动定位
	    mLocationClient.startLocation();
	}
	 @Override
	  protected void onDestroy() {
	    super.onDestroy();
	    //在activity执行onDestroy时执行mMapView.onDestroy()，实现地图生命周期管理
	    mMapView.onDestroy();
	  }
	 @Override
	 protected void onResume() {
	    super.onResume();
	    //在activity执行onResume时执行mMapView.onResume ()，实现地图生命周期管理
	    mMapView.onResume();
	    }
	 @Override
	 protected void onPause() {
	    super.onPause();
	    //在activity执行onPause时执行mMapView.onPause ()，实现地图生命周期管理
	    mMapView.onPause();
	    }
	 @Override
	 protected void onSaveInstanceState(Bundle outState) {
	    super.onSaveInstanceState(outState);
	    //在activity执行onSaveInstanceState时执行mMapView.onSaveInstanceState (outState)，实现地图生命周期管理
	    mMapView.onSaveInstanceState(outState);
	  }  

	@Override
	protected Context getActivityContext() {
		// TODO Auto-generated method stub
		return this;
	}

	@Override
	protected String getActivityName() {
		// TODO Auto-generated method stub
		return "高德地图";
	}
	@Override
	public void activate(OnLocationChangedListener arg0) {
		// TODO Auto-generated method stub
		
	}
	@Override
	public void deactivate() {
		// TODO Auto-generated method stub
		
	}
	
	
	class MyMapLocationListener implements AMapLocationListener
	{
		@Override
		public void onLocationChanged(AMapLocation amapLocation) {
			// TODO Auto-generated method stub
			if (mLocationListener != null && amapLocation != null) {
		         if (amapLocation != null
		             && amapLocation.getErrorCode() == 0) {
//		             mLocationErrText.setVisibility(View.GONE);
		             mLocationListener.onLocationChanged(amapLocation);// 显示系统小蓝点
		         } else {
		             String errText = "定位失败," + amapLocation.getErrorCode()+ ": " + amapLocation.getErrorInfo();
		             Log.e("AmapErr",errText);
//		             mLocationErrText.setVisibility(View.VISIBLE);
//		             mLocationErrText.setText(errText);
		         }
		     }
		}
		
	}
}
